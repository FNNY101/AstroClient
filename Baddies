-- Load Fluent and setup
local Fluent = loadstring(game:HttpGet("https://github.com/dawid-scripts/Fluent/releases/latest/download/main.lua"))()
local SaveManager = loadstring(game:HttpGet("https://raw.githubusercontent.com/dawid-scripts/Fluent/master/Addons/SaveManager.lua"))()
local InterfaceManager = loadstring(game:HttpGet("https://raw.githubusercontent.com/dawid-scripts/Fluent/master/Addons/InterfaceManager.lua"))()

-- Create the Fluent window
local Window = Fluent:CreateWindow({
    Title = "AstroClient-Baddies",
    SubTitle = "Made by Finny<3",
    TabWidth = 160,
    Size = UDim2.fromOffset(580, 460),
    Acrylic = true,
    Theme = "Dark",
    MinimizeKey = Enum.KeyCode.RightControl
})

-- Create tabs
local Tabs = {
    Main = Window:AddTab({ Title = "Main" }),
    Settings = Window:AddTab({ Title = "Settings" }) -- Added Settings Tab
}

-- Initialize toggles
local autofarmEnabled = false
local cashAuraEnabled = false

local AutofarmToggle = Tabs.Main:AddToggle("AutofarmToggle", {
    Title = "Autofarm (Enable Punch before toggling)",
    Default = false
})

local CashAuraToggle = Tabs.Main:AddToggle("CashAuraToggle", {
    Title = "CashAura",
    Default = false, -- Set default to false
    Callback = function(value)
        cashAuraEnabled = value
        getgenv().cashAura = cashAuraEnabled

        if cashAuraEnabled then
            startCashAura()
        end
    end
})

-- Autofarm functionality
local function startAutofarm()
    local plr = game.Players.LocalPlayer
    local cash = workspace:FindFirstChild("Cash")
    local dmg = workspace:FindFirstChild("Damageables")

    if not cash or not dmg then
        warn("Cash or Damageables folder not found in the workspace.")
        return
    end

    -- Prevent player from being idled
    for _, v in next, getconnections(plr.Idled) do
        v:Disable()
    end

    -- Increase the pickup radius
    local function getMoney()
        local cashPickedUp = false
        for _, m in pairs(cash:GetChildren()) do
            if m.Name == "Cash" and (m.Position - plr.Character.HumanoidRootPart.Position).Magnitude <= 35 then
                cashPickedUp = true
                fireproximityprompt(m.ProximityPrompt, 6)
                task.wait(0.2)
            end
        end
        return cashPickedUp
    end

    -- Main autofarm loop
    while getgenv().farm do
        pcall(function()
            for _, a in ipairs(dmg:GetChildren()) do
                if not getgenv().farm then break end
                if a:FindFirstChild("Damageable") and a.Damageable.Value > 0 and a.Name ~= "CashRegister" then
                    -- Teleport to the ATM
                    plr.Character.HumanoidRootPart.CFrame = a.Screen.CFrame * CFrame.new(0, 0, 2)
                    task.wait(1)

                    -- Break the ATM
                    repeat
                        if not getgenv().farm then break end
                        plr.Character.HumanoidRootPart.CFrame = a.Screen.CFrame * CFrame.new(0, 0, 2)
                        game:GetService("ReplicatedStorage"):WaitForChild("PUNCHEVENT"):FireServer(1)
                        task.wait(0.5)
                    until a.Damageable.Value <= 0

                    -- Pick up cash for 2 seconds
                    local endTime = tick() + 2
                    local cashPickedUp
                    repeat
                        if not getgenv().farm then break end
                        cashPickedUp = getMoney()
                        task.wait(0.1)
                    until tick() >= endTime and not cashPickedUp

                    -- Move to next ATM if no cash was picked up
                    if not cashPickedUp then
                        task.wait(.5)
                    end
                end
            end
        end)
        task.wait(.5)
    end
end

-- CashAura functionality
local function startCashAura()
    local plr = game.Players.LocalPlayer
    local cash = workspace:FindFirstChild("Cash")

    if not cash then
        warn("Cash folder not found in the workspace.")
        return
    end

    -- Increase the pickup radius
    local function getMoney()
        local cashPickedUp = false
        for _, m in pairs(cash:GetChildren()) do
            if m.Name == "Cash" and (m.Position - plr.Character.HumanoidRootPart.Position).Magnitude <= 300 then
                cashPickedUp = true
                fireproximityprompt(m.ProximityPrompt, 6)
                task.wait(0.1)
            end
        end
        return cashPickedUp
    end

    -- Main cash aura loop
    while getgenv().cashAura do
        pcall(function()
            getMoney()
            task.wait(1) -- Check every 1 second
        end)
        task.wait(1)
    end
end

-- Toggle actions
AutofarmToggle:OnChanged(function(value)
    autofarmEnabled = value
    getgenv().farm = autofarmEnabled

    if autofarmEnabled then
        startAutofarm()
    end
end)

-- Settings and Save Manager Integration
SaveManager:SetLibrary(Fluent)
InterfaceManager:SetLibrary(Fluent)
SaveManager:IgnoreThemeSettings()
SaveManager:SetIgnoreIndexes({})
InterfaceManager:SetFolder("FluentScriptHub")
SaveManager:SetFolder("FluentScriptHub/specific-game")
InterfaceManager:BuildInterfaceSection(Tabs.Settings) -- Added settings section
SaveManager:BuildConfigSection(Tabs.Settings) -- Added config section
Window:SelectTab(1)
SaveManager:LoadAutoloadConfig()
